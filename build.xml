<!-- 优先使用命令行参数，否则使用环境变量 -->
<property name="jmeter.home" value="${env.JMETER_HOME}"/>
<property name="report.dir" value="${basedir}/build/reports"/>
<property name="jtl.dir" value="${basedir}/build/jtl"/>
<property name="jmx.dir" value="${basedir}/jmx"/>
<property name="lib.dir" value="${basedir}/lib"/>

<!-- 初始化任务定义 -->
<taskdef name="jmeter"
         classname="org.programmerplanet.ant.taskdefs.jmeter.JMeterTask"
         classpath="${lib.dir}/jmeter-ant-task-1.10.1.jar"/>

<!-- 清理目录 -->
<target name="clean">
    <delete dir="${report.dir}"/>
    <delete dir="${jtl.dir}"/>
    <mkdir dir="${report.dir}"/>
    <mkdir dir="${jtl.dir}"/>
</target>

<!-- 运行JMeter测试 -->
<target name="run" depends="clean">
    <echo message="开始执行JMeter测试..."/>
    <echo>JMeter Home: ${jmeter.home}</echo>
    <echo>当前工作目录 (basedir): ${basedir}</echo>
    <echo>JMX文件路径 (如果已定义): ${jmeter.test.file}</echo>
    
    <!-- 验证JMeter Home是否存在 -->
    <available file="${jmeter.home}/bin/ApacheJMeter.jar" property="jmeter.jar.exists"/>
    <fail unless="jmeter.jar.exists" message="JMeter Home目录无效，请检查JMETER_HOME环境变量或命令行参数设置"/>
    
    <tstamp>
        <format property="time" pattern="yyyyMMdd-HHmmss"/>
    </tstamp>
    
    <jmeter jmeterhome="${jmeter.home}"
            resultlog="${jtl.dir}/test-${time}.jtl"
            failureproperty="jmeter.failed">
        <testplans dir="${jmx.dir}" includes="**/*.jmx"/>
    </jmeter>
    
    <echo message="测试结果文件: ${jtl.dir}/test-${time}.jtl"/>
    <fail if="jmeter.failed" message="JMeter测试失败"/>
</target>


<!-- 生成HTML报告 -->
<target name="report" depends="run">
    <echo message="生成HTML报告..."/>
    
    <!-- 找到最新的JTL文件 -->
    <last id="latest">
        <fileset dir="${jtl.dir}" includes="*.jtl"/>
    </last>
    
    <java classname="org.apache.jmeter.report.cli.ReportGenerator"
          fork="true" failonerror="true">
        <classpath>
            <fileset dir="${jmeter.home}/lib" includes="**/*.jar"/>
            <fileset dir="${jmeter.home}/lib/ext" includes="**/*.jar"/>
        </classpath>
        <arg value="-i"/>
        <arg value="${jtl.dir}/@{latest}"/>
        <arg value="-o"/>
        <arg value="${report.dir}/html-@{latest}"/>
        <arg value="-f"/>
        <arg value="HTML"/>
    </java>
    
    <!-- 复制报告到Jenkins可访问目录 -->
    <copy todir="${report.dir}/latest">
        <fileset dir="${report.dir}/html-@{latest}"/>
    </copy>
    
    <echo message="HTML报告生成完成: ${report.dir}/latest/index.html"/>
</target>

<!-- 发送邮件通知 -->
<target name="send-email" depends="report">
    <echo message="发送邮件通知..."/>
    <!-- 配置邮件发送逻辑 -->
</target>